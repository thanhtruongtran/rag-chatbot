name: CICD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create necessary directories
        run: |
          mkdir -p infrastructure/storage/chromadb
          mkdir -p logs

      - name: Start infrastructure services
        run: |
          cd infrastructure
          echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" > router/.env
          
          # Only start Redis and LiteLLM 
          docker compose up -d semantic-redis litellm
        
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be healthy..."
          # Wait for Redis
          timeout 60 bash -c 'until docker exec semantic-redis redis-cli ping; do sleep 2; done'
          # Wait for LiteLLM
          timeout 120 bash -c 'until curl -f http://localhost:4000/health/liveliness; do sleep 5; done'

      - name: Run tests
        run: |
          export LITELLM_BASE_URL=http://localhost:4000
          export GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
          export REDIS_URI=localhost:6378
          export CHROMA_PERSIST_DIR=./infrastructure/storage/chromadb
          export LANGFUSE_HOST=https://cloud.langfuse.com
          export LANGFUSE_PUBLIC_KEY=${{ secrets.LANGFUSE_PUBLIC_KEY }}
          export LANGFUSE_SECRET_KEY=${{ secrets.LANGFUSE_SECRET_KEY }}
          
          # Run tests
          python -m pytest tests/test_simple.py -v 

      - name: Cleanup services
        if: always()
        run: |
          cd infrastructure
          docker compose down -v
          docker system prune -f

  build:
    needs: test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/rag-ops:latest
          cache-from: type=registry,ref=${{ vars.DOCKERHUB_USERNAME }}/rag-ops:buildcache
          cache-to: type=registry,ref=${{ vars.DOCKERHUB_USERNAME }}/rag-ops:buildcache,mode=max

  # deploy:
  #   needs: build
  #   if: github.event_name == 'push'
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4

  #   - name: SSH to EC2
  #     uses: appleboy/ssh-action@v1.2.0
  #     with:
  #       host: ${{ secrets.EC2_HOST }}
  #       username: ${{ secrets.EC2_USER }}
  #       key: ${{ secrets.EC2_PEM_KEY }}
  #       script: |
  #         cd /opt/rag-ops
  #         git pull origin main
  #         cd infrastructure
  #         docker compose down
  #         docker system prune -f
  #         docker compose pull
  #         docker compose up -d

